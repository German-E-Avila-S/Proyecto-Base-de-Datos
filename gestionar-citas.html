<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Citas</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f7f7f7; }
        .container { max-width: 1100px; }
    </style>
</head>

<body>

<!-- NAVBAR DINÁMICO -->
<div id="navbar"></div>

<script>
  fetch('/navbar.html')
    .then(r => r.text())
    .then(d => { document.getElementById('navbar').innerHTML = d })
    .catch(e => console.error("NAVBAR ERROR:", e));
</script>

<!-- MENÚ DINÁMICO -->
<script>
  fetch('/tipo-usuario')
    .then(r => r.json())
    .then(data => {

      const addItem = (html) => {
        const menu = document.getElementById('menu');
        if (menu) menu.innerHTML += html;
      };

      const tipo = data.tipo_usuario;

      if (tipo === 'admin') {
        addItem('<li><a class="dropdown-item" href="/gestionar-citas.html">Gestión Citas</a></li>');
        addItem('<li><a class="dropdown-item" href="/mis-datos">Mis Datos</a></li>');
        addItem('<li><a class="dropdown-item" href="/gestionar-usuarios.html">Gestión Usuarios</a></li>');
        addItem('<li><a class="dropdown-item" href="/gestionar-pacientes.html">Gestión Pacientes</a></li>');
        addItem('<li><a class="dropdown-item" href="/gestionar-medicos.html">Gestión Médicos</a></li>');
      } else {
        addItem('<li><a class="dropdown-item" href="/mis-datos">Mis Datos</a></li>');
      }

      addItem('<li><a class="dropdown-item text-danger" href="/logout">Cerrar Sesión</a></li>');
    });
</script>


<div class="container mt-5">

    <h1 class="text-center mb-4">Gestión de Citas</h1>

    <!-- BUSCADOR -->
    <input 
        type="text"
        id="busqueda"
        class="form-control mb-4"
        placeholder="Buscar por ID, nombre del paciente o estado..."
    >

    <!-- Alertas -->
    <div id="alerta" class="mt-3"></div>

    <!-- TABLA -->
    <table class="table table-striped table-bordered shadow-sm" id="tablaCitas">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>ID Paciente</th>
                <th>Paciente</th>
                <th>Fecha de Cita</th>
                <th>Motivo</th>
                <th>Estado</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody></tbody>
    </table>

    <a href="/" class="btn btn-secondary">Volver</a>

</div>


<!-- ===================================================== -->
<!-- =========== FORMULARIO DE RESULTADOS ================= -->
<!-- ===================================================== -->
<div class="container mt-5">

  <div class="card shadow">
    <div class="card-header bg-danger text-white text-center">
      <h4 class="mb-0">Registrar Resultados Básicos</h4>
    </div>

    <div class="card-body">

      <form action="/resultados-basicos/agregar" method="POST">

        <!-- ID del Paciente oculto -->
        <input type="hidden" name="paciente_id" id="paciente_id">

        <!-- ID de la cita -->
        <div class="mb-3">
          <label class="form-label">ID de la Cita</label>
          <input type="number" name="cita_id" id="cita_id" class="form-control" required>
        </div>

        <!-- Nombre del paciente autocompletado -->
        <div class="mb-3">
          <label class="form-label">Paciente</label>
          <input type="text" id="paciente_nombre_res" class="form-control" disabled>
        </div>

        <hr>
        <h5 class="text-primary">Biometría Hemática</h5>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label>Hemoglobina</label>
            <input type="number" step="0.01" name="hemoglobina" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Hematocrito</label>
            <input type="number" step="0.01" name="hematocrito" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Glóbulos Rojos</label>
            <input type="number" step="0.01" name="globulos_rojos" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Glóbulos Blancos</label>
            <input type="number" step="0.01" name="globulos_blancos" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Plaquetas</label>
            <input type="number" step="0.01" name="plaquetas" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Neutrófilos</label>
            <input type="number" step="0.01" name="neutrofilos" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Linfocitos</label>
            <input type="number" step="0.01" name="linfocitos" class="form-control">
          </div>
        </div>

        <hr>
        <h5 class="text-primary">Química Sanguínea</h5>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label>Glucosa</label>
            <input type="number" step="0.01" name="glucosa" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Creatinina</label>
            <input type="number" step="0.01" name="creatinina" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Urea</label>
            <input type="number" step="0.01" name="urea" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>ALT</label>
            <input type="number" step="0.01" name="alt" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>AST</label>
            <input type="number" step="0.01" name="ast" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Colesterol Total</label>
            <input type="number" step="0.01" name="colesterol_total" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Triglicéridos</label>
            <input type="number" step="0.01" name="trigliceridos" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Sodio</label>
            <input type="number" step="0.01" name="sodio" class="form-control">
          </div>

          <div class="col-md-3 mb-3">
            <label>Potasio</label>
            <input type="number" step="0.01" name="potasio" class="form-control">
          </div>
        </div>

        <button class="btn btn-danger w-100 mt-3">Guardar Resultados</button>

      </form>

    </div>
  </div>
</div>

<script>
// Autocompletar paciente según cita
document.getElementById("cita_id").addEventListener("change", async function () {
    const citaId = this.value;

    if (!citaId) return;

    try {
        const res = await fetch(`/api/cita/${citaId}`);
        const data = await res.json();

        if (data.ok) {
            document.getElementById("paciente_id").value = data.paciente.id;
            document.getElementById("paciente_nombre_res").value = data.paciente.nombre;
        } else {
            alert("Cita no encontrada");
            document.getElementById("paciente_id").value = "";
            document.getElementById("paciente_nombre_res").value = "";
        }

    } catch (err) {
        console.error(err);
    }
});
</script>


<script>
// Autocompletar paciente según cita
document.getElementById("cita_id").addEventListener("change", async function () {
    const citaId = this.value;

    if (!citaId) return;

    try {
        const res = await fetch(`/api/cita/${citaId}`);
        const data = await res.json();

        if (data.ok) {
            document.getElementById("paciente_id").value = data.paciente.id;
            document.getElementById("paciente_nombre_res").value = data.paciente.nombre;
        } else {
            alert("Cita no encontrada");
            document.getElementById("paciente_id").value = "";
            document.getElementById("paciente_nombre_res").value = "";
        }

    } catch (err) {
        console.error(err);
    }
});
</script>


<script>
// Autocompletar paciente según cita
document.getElementById("cita_id").addEventListener("change", () => {
    const id = document.getElementById("cita_id").value;

    if (!id) return;

    fetch(`/api/cita/${id}`)
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          document.getElementById("paciente_nombre_res").value = data.paciente.nombre;
          document.getElementById("paciente_id").value = data.paciente.id;
        } else {
          document.getElementById("paciente_nombre_res").value = "No encontrado";
          document.getElementById("paciente_id").value = "";
        }
      });
});
</script>

<script>
// Buscar paciente por cita_id
document.getElementById("cita_id").addEventListener("change", () => {
    const citaId = document.getElementById("cita_id").value;
    if (!citaId) return;

    fetch(`/api/cita/${citaId}`)
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          document.getElementById("paciente_nombre_res").value = data.paciente.nombre;
          document.getElementById("paciente_id").value = data.paciente.id;
        } else {
          document.getElementById("paciente_nombre_res").value = "No encontrado";
        }
      });
});
</script>




<!-- ========= MODAL EDITAR ========= -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Editar Cita</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formEditar">

          <input type="hidden" id="edit_id">

          <div class="mb-3">
            <label class="form-label">Fecha y hora</label>
            <input type="datetime-local" id="edit_fecha_cita" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Motivo</label>
            <input type="text" id="edit_motivo" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select id="edit_estado" class="form-select">
              <option value="pendiente">Pendiente</option>
              <option value="completada">Completada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>

          <button type="submit" class="btn btn-success w-100">Guardar Cambios</button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!-- ===================================================== -->
<!-- ===================== SCRIPTS ======================== -->
<!-- ===================================================== -->

<script>

const modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));

function mostrarAlerta(msg, tipo="success") {
  document.getElementById("alerta").innerHTML = `
    <div class="alert alert-${tipo} alert-dismissible fade show">
      ${msg}
      <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
}

function cargarCitas(filtro="") {
  fetch(`/api/citas/buscar?query=${filtro}`)
    .then(r => r.json())
    .then(citas => {
      const tbody = document.querySelector("#tablaCitas tbody");
      tbody.innerHTML = "";

      citas.forEach(c => {

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.paciente_id}</td>
          <td>${c.paciente_nombre}</td>
          <td>${new Date(c.fecha_cita).toLocaleString()}</td>
          <td>${c.motivo || "—"}</td>

          <td>
            <span class="badge
              ${c.estado === "pendiente" ? "bg-warning" :
                c.estado === "completada" ? "bg-success" : "bg-danger"}">
              ${c.estado}
            </span>
          </td>

          <td>${new Date(c.fecha_registro).toLocaleString()}</td>

          <td>
            <button class="btn btn-primary btn-sm me-1" onclick='abrirEditar(${JSON.stringify(c)})'>Editar</button>

            <form action="/citas/eliminar/${c.id}" method="POST" style="display:inline;">
              <button class="btn btn-danger btn-sm" onclick="return confirm('¿Eliminar cita?');">Eliminar</button>
            </form>
          </td>
        `;

        tbody.appendChild(tr);
      });
    });
}

cargarCitas();

document.getElementById("busqueda").addEventListener("input", e => {
  cargarCitas(e.target.value.trim());
});

function abrirEditar(c) {

  document.getElementById("edit_id").value = c.id;

  let fecha = new Date(c.fecha_cita).toISOString().slice(0,16);

  document.getElementById("edit_fecha_cita").value = fecha;
  document.getElementById("edit_motivo").value = c.motivo || "";
  document.getElementById("edit_estado").value = c.estado;

  modalEditar.show();
}

document.getElementById("formEditar").addEventListener("submit", e => {
  e.preventDefault();

  const id = document.getElementById("edit_id").value;

  let fecha = document.getElementById("edit_fecha_cita").value;
  fecha = fecha.replace("T"," ") + ":00";

  const data = {
    fecha_cita: fecha,
    motivo: document.getElementById("edit_motivo").value,
    estado: document.getElementById("edit_estado").value
  };

  fetch(`/citas/editar/${id}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  }).then(r => r.json())
    .then(d => {
      if (d.ok) {
        mostrarAlerta(d.mensaje);
        setTimeout(() => location.reload(), 1200);
      } else {
        mostrarAlerta(d.mensaje, "danger");
      }
    });
});


/* ============================================================
   AUTOCOMPLETAR NOMBRE DEL PACIENTE AL ESCRIBIR ID CITA
   ============================================================ */
document.getElementById("cita_id").addEventListener("change", () => {
    const id = document.getElementById("cita_id").value;

    if (!id) return;

    fetch(`/api/citas/buscar?query=${id}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          document.getElementById("paciente_nombre_res").value = data[0].paciente_nombre;
        } else {
          document.getElementById("paciente_nombre_res").value = "No encontrado";
        }
      });
});

</script>

</body>
</html>
